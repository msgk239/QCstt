# 语音识别文本纠正方案

## 目标
对ASR识别结果进行后处理，将相似发音的词纠正为预设的目标词。

## 技术方案
使用拼音相似度匹配：
1. 预处理阶段：
   - 从 keywords 文件加载目标词表
   - 将目标词转换为拼音表示
   - 建立拼音-目标词的映射关系
   - 支持多音字处理

2. 匹配阶段：
   - 将识别文本分词
   - 转换为拼音表示
   - 计算拼音相似度
   - 根据阈值进行纠正

3. 优化策略：
   - 支持单词级别的自定义阈值
   - 缓存常见词的拼音结果
   - 自动同步配置文件

## 配置方式
1. keywords 文件格式：
```txt
本源
检测点 0.75 # 可选：指定单独的阈值
心智控制区
第一灵 0.8 检测点A,检测点B # 数字为阈值，后面是原词列表
整场 0.8 整仓,城产 (互催,互催下来) # 带上下文词要求的配置
```

2. 自动生成的 yaml 配置：
```yaml
target_words:
  本源:
    pinyin: [ben3, yuan2]
    context_words: []  # 无上下文要求
    similarity_threshold: 0.6 # 默认阈值
    original_words: []  # 原词列表
  第一灵:
    pinyin: [di4, yi1, ling2]
    context_words: []  # 无上下文要求
    similarity_threshold: 0.8 # 自定义阈值
    original_words: [检测点A, 检测点B]  # 原词列表
  整场:
    pinyin: [zheng3, chang3]
    context_words: [互催, 互催下来]  # 有上下文要求
    similarity_threshold: 0.8
    original_words: [整仓, 城产]  # 原词列表
```

## 使用说明
- 直接编辑 keywords 文件添加/删除目标词
- 可在词后添加数字来设置单独的阈值（0-1之间）
- 可在阈值后添加原词列表，使用逗号分隔（中文逗号"，"和英文逗号","都可以）
- 可以用括号指定上下文词要求：(上下文词1,上下文词2)
- 不指定阈值时使用默认值 0.6
- yaml 配置文件会自动更新
- 原词映射优先级最高，匹配到原词会直接返回目标词

## 匹配优先级说明
1. 原词匹配（最高优先级）：
   - 直接匹配原词列表中的词
   - 不考虑相似度和上下文要求
   - 例如："整仓" -> "整场"，不需要检查上下文

2. 相似度匹配（次优先级）：
   - 无上下文要求的目标词：
     * 只检查拼音相似度是否达到阈值
     * 例如："第一令" -> "第一灵"
   - 有上下文要求的目标词：
     * 必须同时满足两个条件：
       1. 拼音相似度达到阈值
       2. 文本中包含指定的上下文词
     * 例如："正常" -> "整场" 只在有"互催"等上下文词时才会发生

## 原词映射说明
1. 原词映射功能允许将多个不同的词映射到同一个目标词
2. 原词匹配优先级高于拼音相似度匹配
3. 配置格式：`目标词 [阈值] 原词1,原词2`
4. 适用场景：
   - 处理同义词或缩写
   - 处理特定场景下的专有名词映射
   - 处理无法通过拼音相似度准确匹配的情况

## 注意事项
- 目标词不建议超过1000个
- 支持大规模文本实时处理
- 需要定期根据实际效果更新目标词表
- 建议根据实际场景调整相似度阈值

python -m server.api.speech.test_correction
python -m server.api.speech.test_correct_recognition